<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="./favicon.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI 디자인 피드백 번역기</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              'brand-bg': '#121212',
              'surface': '#1e1e1e',
              'primary': '#6366f1',
              'primary-hover': '#4f46e5',
              'on-surface': '#e5e7eb',
              'on-surface-secondary': '#9ca3af',
            },
            fontFamily: {
              sans: ['Pretendard', 'sans-serif'],
            },
          },
        },
      };
    </script>
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script>
      // 중요: AI 기능을 사용하려면 아래에 자신의 Google AI Studio API 키를 입력하세요.
      // API 키는 https://aistudio.google.com/app/apikey 에서 발급받을 수 있습니다.
      window.GEMINI_API_KEY = "AIzaSyAZkb9O1JY4ex4xjd6w9LD9hNe2NhgIy2g";
    </script>
    <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.1.1",
    "react-dom/": "https://esm.sh/react-dom@^19.1.1/",
    "react/": "https://esm.sh/react@^19.1.1/",
    "@google/genai": "https://esm.sh/@google/genai@^1.11.0"
  }
}
</script>
<link rel="stylesheet" href="/index.css">
</head>
  <body class="bg-brand-bg">
    <div id="root"></div>
    <script type="text/babel" data-type="module">
import React, { useState, useCallback, useRef, useEffect } from 'react';
import ReactDOM from 'react-dom/client';
import { GoogleGenAI, Type } from "@google/genai";

// --- Types ---
const FeedbackCategory = {
  TYPOGRAPHY: 'Typography',
  COLOR: 'Color',
  LAYOUT: 'Layout',
  COMPONENT: 'Component',
  INTERACTION: 'Interaction',
  GENERAL: 'General',
};

// --- Constants ---
const EXAMPLE_PROMPTS = [
  '좀 더 세련되게 만들어주세요.',
  '뭔가 허전한 느낌이에요.',
  '사용자가 더 오래 머물게 하고 싶어요.',
  '좀 더 전문가적인 느낌이 나도록 해주세요.',
  '눈에 잘 안 들어와요.',
];

const CATEGORY_STYLES = {
  [FeedbackCategory.TYPOGRAPHY]: { icon: 'T', color: 'bg-sky-500', label: '타이포그래피' },
  [FeedbackCategory.COLOR]: { icon: 'C', color: 'bg-rose-500', label: '색상' },
  [FeedbackCategory.LAYOUT]: { icon: 'L', color: 'bg-amber-500', label: '레이아웃' },
  [FeedbackCategory.COMPONENT]: { icon: 'Co', color: 'bg-emerald-500', label: '컴포넌트' },
  [FeedbackCategory.INTERACTION]: { icon: 'I', color: 'bg-violet-500', label: '인터랙션' },
  [FeedbackCategory.GENERAL]: { icon: 'G', color: 'bg-gray-500', label: '일반' },
};

// --- Gemini Service ---
let ai;
let initialError = null;

try {
  if (!window.GEMINI_API_KEY || window.GEMINI_API_KEY === "여기에_API_키를_입력하세요") {
    throw new Error("API 키가 설정되지 않았습니다. 이 파일 상단의 window.GEMINI_API_KEY 변수에 자신의 API 키를 입력해주세요.");
  }
  ai = new GoogleGenAI({ apiKey: window.GEMINI_API_KEY });
} catch (e) {
  console.error("GoogleGenAI 초기화 실패:", e);
  const errorMessage = e instanceof Error ? e.message : "AI 기능이 비활성화되었습니다.";
  initialError = errorMessage;
  ai = {
    models: {
      generateContent: () => Promise.reject(new Error(errorMessage)),
    }
  };
}

const systemInstruction = `
당신은 세계적인 UI/UX 디자인 전문가입니다.
사용자가 입력하는 모호하고 막연한 디자인 피드백을 듣고, 이를 구체적이고 실행 가능한 몇 가지 디자인 개선 제안으로 번역하는 역할을 합니다.
사용자가 스크린샷 이미지를 함께 제공할 경우, 해당 이미지를 분석하여 피드백의 맥락을 파악하고, 이미지에 기반한 구체적인 제안을 해주세요.
답변은 항상 JSON 형식이어야 합니다. 제안은 'category'와 'suggestion' 필드를 포함하는 객체의 배열로 구성됩니다.
'category'는 다음 중 하나여야 합니다: 'Typography', 'Color', 'Layout', 'Component', 'Interaction', 'General'.
각 제안은 명확하고, 구체적이며, 디자이너나 개발자가 바로 이해하고 적용할 수 있도록 작성해주세요.
`;

const responseSchema = {
  type: Type.ARRAY,
  items: {
    type: Type.OBJECT,
    properties: {
      category: {
        type: Type.STRING,
        enum: Object.values(FeedbackCategory),
        description: '디자인 제안의 카테고리',
      },
      suggestion: {
        type: Type.STRING,
        description: '구체적인 디자인 개선 제안',
      },
    },
    required: ['category', 'suggestion'],
  },
};

const translateFeedback = async (feedback, imagePart) => {
  if (initialError) {
      throw new Error(initialError);
  }
  try {
    const textPart = { text: feedback };
    const contents = imagePart ? { parts: [imagePart, textPart] } : feedback;

    const response = await ai.models.generateContent({
      model: "gemini-2.5-flash",
      contents: contents,
      config: {
        systemInstruction: systemInstruction,
        responseMimeType: "application/json",
        responseSchema: responseSchema,
        temperature: 0.7,
        topP: 0.95,
      },
    });

    const jsonText = response.text.trim();
    if (!jsonText) throw new Error("API가 비어있는 응답을 반환했습니다.");
    
    const suggestions = JSON.parse(jsonText);
    if (!Array.isArray(suggestions)) throw new Error("API 응답이 유효한 배열 형식이 아닙니다.");

    return suggestions;

  } catch (error) {
    console.error("Gemini API call failed:", error);
    if (error instanceof Error && error.message.includes("JSON")) {
        throw new Error("API 응답을 파싱하는 데 실패했습니다. 유효한 JSON이 아닙니다.");
    }
    const message = error instanceof Error ? error.message : String(error);
    throw new Error(`Gemini API 요청 중 문제가 발생했습니다: ${message}`);
  }
};

const generateExamplePrompts = async () => {
  if (initialError) {
      console.warn("AI 기능이 비활성화되어 예시를 생성할 수 없습니다.");
      return [];
  }
  try {
    const response = await ai.models.generateContent({
      model: "gemini-2.5-flash",
      contents: "디자인에 대한 모호하고 막연한 피드백 예시 5개를 한국어로 생성해줘. 짧고 흔하게 사용되는 문장으로 부탁해. 예를 들어 '좀 더 세련되게 만들어주세요.' 같은 느낌으로.",
      config: {
        systemInstruction: "당신은 디자인 팀장에게 피드백을 주는 사용자 역할을 합니다. 항상 JSON 형식으로 응답해야 합니다. 응답은 5개의 문자열을 담은 배열이어야 합니다.",
        responseMimeType: "application/json",
        responseSchema: { type: Type.ARRAY, items: { type: Type.STRING } },
        temperature: 1.0,
      },
    });

    const jsonText = response.text.trim();
    if (!jsonText) return [];
    const examples = JSON.parse(jsonText);
    return Array.isArray(examples) ? examples : [];

  } catch (error) {
    console.error("Failed to generate example prompts:", error);
    return [
      '좀 더 생동감 있게 만들어 주세요.',
      '뭔가 정리가 안 된 느낌이에요.',
      '사용자가 신뢰할 수 있도록 바꿔주세요.',
      '너무 복잡해서 사용하기 어려워요.',
      '더 직관적으로 만들어 주세요.',
    ];
  }
};


// --- Components ---

const SparkleIcon = () => (
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-primary">
        <path d="M12 3L9.5 8.5L4 11L9.5 13.5L12 19L14.5 13.5L20 11L14.5 8.5L12 3Z"/>
        <path d="M5 22L7 17"/>
        <path d="M19 22L17 17"/>
    </svg>
);

function Header() {
  return (
    <header className="py-4 border-b border-gray-800">
      <div className="container mx-auto px-4 md:px-8 flex items-center gap-3">
        <SparkleIcon />
        <h1 className="text-xl md:text-2xl font-bold text-on-surface tracking-tight">
          AI 디자인 피드백 번역기
        </h1>
      </div>
    </header>
  );
}

function Footer() {
  return (
    <footer className="py-4 mt-8 border-t border-gray-800">
      <div className="container mx-auto px-4 md:px-8 text-center text-on-surface-secondary text-sm">
        <p>Powered by Google Gemini. Created for demonstration purposes.</p>
      </div>
    </footer>
  );
}

function ResultCard({ suggestion }) {
  const style = CATEGORY_STYLES[suggestion.category] || CATEGORY_STYLES.General;
  return (
    <div className="bg-brand-bg border border-gray-700 rounded-lg p-4 flex items-start gap-4 transition-all hover:border-primary hover:shadow-lg">
      <div className={`w-10 h-10 rounded-full flex-shrink-0 flex items-center justify-center font-bold text-white text-sm ${style.color}`}>
        {style.icon}
      </div>
      <div className="flex-grow">
        <span className={`text-sm font-semibold ${style.color.replace('bg-', 'text-')}`}>{style.label}</span>
        <p className="text-on-surface mt-1">{suggestion.suggestion}</p>
      </div>
    </div>
  );
}

const SkeletonCard = () => (
  <div className="bg-surface rounded-lg p-4 animate-pulse flex items-start gap-4">
    <div className="w-10 h-10 rounded-full bg-gray-700 flex-shrink-0"></div>
    <div className="flex-grow">
      <div className="h-4 bg-gray-700 rounded w-1/4 mb-3"></div>
      <div className="h-3 bg-gray-700 rounded w-full mb-2"></div>
      <div className="h-3 bg-gray-700 rounded w-5/6"></div>
    </div>
  </div>
);

const EmptyState = ({ initialError }) => (
    <div className="flex flex-col items-center justify-center text-center p-8 border-2 border-dashed border-gray-700 rounded-lg h-full">
        {initialError ? (
            <>
                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1" strokeLinecap="round" strokeLinejoin="round" className="text-red-500 mb-4">
                    <circle cx="12" cy="12" r="10" />
                    <line x1="12" x2="12" y1="8" y2="12" />
                    <line x1="12" x2="12.01" y1="16" y2="16" />
                </svg>
                <h3 className="text-lg font-semibold text-red-400">AI 초기화 오류</h3>
                <p className="text-on-surface-secondary mt-1 max-w-md">{initialError}</p>
            </>
        ) : (
            <>
                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1" strokeLinecap="round" strokeLinejoin="round" className="text-gray-600 mb-4">
                    <path d="m18 16 4-4-4-4"/><path d="m6 8-4 4 4 4"/><path d="m14.5 4-5 16"/>
                </svg>
                <h3 className="text-lg font-semibold text-on-surface">결과가 여기에 표시됩니다</h3>
                <p className="text-on-surface-secondary mt-1">왼쪽 입력창에 피드백을 입력하고<br/>'피드백 구체화하기' 버튼을 눌러주세요.</p>
            </>
        )}
    </div>
);

function ResultsDisplay({ results, isLoading, error, hasTranslated }) {
  const showError = error;
  
  return (
    <div className="bg-surface rounded-lg p-6 shadow-lg h-full">
      <h2 className="text-lg font-semibold text-on-surface mb-4">2. 구체화된 디자인 제안</h2>
      <div className="space-y-4">
        {isLoading && <><SkeletonCard /><SkeletonCard /><SkeletonCard /></>}
        {!isLoading && showError && (
          <div className="bg-red-900/50 border border-red-700 text-red-200 px-4 py-3 rounded-lg" role="alert">
            <strong className="font-bold">오류 발생: </strong>
            <span className="block sm:inline">{showError}</span>
          </div>
        )}
        {!isLoading && !showError && hasTranslated && results.length === 0 && (
          <div className="text-center py-10 text-on-surface-secondary">
             <p>AI가 제안을 생성하지 못했습니다. <br/> 좀 더 명확한 피드백으로 다시 시도해보세요.</p>
          </div>
        )}
        {!isLoading && !showError && results.length > 0 && results.map((result, index) => <ResultCard key={index} suggestion={result} />)}
        {!isLoading && !hasTranslated && <EmptyState initialError={initialError} />}
      </div>
    </div>
  );
}

const LoadingSpinner = () => (
    <svg className="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
        <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
    </svg>
);

const UploadIcon = () => (
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="mx-auto mb-2 text-gray-500">
    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="17 8 12 3 7 8" /><line x1="12" x2="12" y1="3" y2="15" />
  </svg>
);

const RefreshIcon = ({ spinning }) => (
    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={spinning ? 'animate-spin' : ''}>
        <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8" /><path d="M21 3v5h-5" /><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16" /><path d="M3 21v-5h5" />
    </svg>
);

function FeedbackInput({ userInput, setUserInput, image, setImage, onSubmit, isLoading, disabled }) {
  const [isDragging, setIsDragging] = useState(false);
  const [imagePreview, setImagePreview] = useState(null);
  const [examplePrompts, setExamplePrompts] = useState(EXAMPLE_PROMPTS);
  const [isFetchingExamples, setIsFetchingExamples] = useState(false);
  const fileInputRef = useRef(null);
  
  useEffect(() => {
    if (image) {
      const objectUrl = URL.createObjectURL(image);
      setImagePreview(objectUrl);
      return () => URL.revokeObjectURL(objectUrl);
    } else {
      setImagePreview(null);
    }
  }, [image]);

  const handleFileChange = (e) => {
    if (e.target.files && e.target.files[0]) setImage(e.target.files[0]);
  };

  const handleDrop = useCallback((e) => {
    e.preventDefault(); e.stopPropagation(); setIsDragging(false);
    if (e.dataTransfer.files && e.dataTransfer.files[0] && e.dataTransfer.files[0].type.startsWith('image/')) {
      setImage(e.dataTransfer.files[0]);
    } else {
      alert('이미지 파일만 업로드할 수 있습니다.');
    }
  }, [setImage]);

  const handleDragOver = useCallback((e) => {
    e.preventDefault(); e.stopPropagation(); if (!isDragging) setIsDragging(true);
  }, [isDragging]);

  const handleDragLeave = useCallback((e) => {
    e.preventDefault(); e.stopPropagation(); setIsDragging(false);
  }, []);

  const removeImage = () => {
    setImage(null);
    if (fileInputRef.current) fileInputRef.current.value = "";
  };
  
  const handleFetchNewExamples = useCallback(async () => {
    setIsFetchingExamples(true);
    try {
      const newPrompts = await generateExamplePrompts();
      if (newPrompts && newPrompts.length > 0) setExamplePrompts(newPrompts);
    } catch(e) {
      console.error(e.message);
    } finally {
      setIsFetchingExamples(false);
    }
  }, []);

  return (
    <div className="bg-surface rounded-lg p-6 shadow-lg h-full flex flex-col gap-6">
      <div>
        <h2 className="text-lg font-semibold text-on-surface">1. 모호한 피드백 입력</h2>
        <p className="text-sm text-on-surface-secondary mt-1">어떤 디자인 피드백을 받았나요? 그대로 입력해보세요.</p>
      </div>
      <textarea
        value={userInput}
        onChange={(e) => setUserInput(e.target.value)}
        onKeyDown={(e) => { if (!disabled && e.key === 'Enter' && (e.metaKey || e.ctrlKey)) onSubmit(); }}
        placeholder={disabled ? "AI 기능이 비활성화되었습니다." : "예: '좀 더 세련되게 바꿔주세요...'"}
        className="w-full text-base bg-brand-bg border border-gray-600 rounded-md p-3 focus:ring-2 focus:ring-primary focus:outline-none transition-shadow duration-200 resize-none disabled:cursor-not-allowed disabled:opacity-50"
        rows={4}
        disabled={disabled}
      />
       <div>
        <h3 className="text-base font-medium text-on-surface mb-2">선택사항: 디자인 스크린샷 첨부</h3>
        <input type="file" ref={fileInputRef} onChange={handleFileChange} className="hidden" accept="image/*" disabled={disabled} />
        {imagePreview ? (
            <div className="relative group">
                <img src={imagePreview} alt="Preview" className="w-full h-auto max-h-48 object-contain rounded-md bg-brand-bg" />
                {!disabled && <button onClick={removeImage} className="absolute top-2 right-2 bg-black/50 text-white rounded-full p-1.5 opacity-0 group-hover:opacity-100 transition-opacity" aria-label="Remove image">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
                </button>}
            </div>
        ) : (
            <div
                onDrop={!disabled ? handleDrop : undefined} onDragOver={!disabled ? handleDragOver : undefined} onDragLeave={!disabled ? handleDragLeave : undefined}
                onClick={() => !disabled && fileInputRef.current?.click()}
                className={`flex flex-col justify-center items-center w-full h-32 px-4 text-center border-2 border-dashed rounded-lg transition-colors ${disabled ? 'border-gray-700 bg-black/20 cursor-not-allowed' : `cursor-pointer ${isDragging ? 'border-primary bg-primary/10' : 'border-gray-600 hover:border-gray-500'}`}`}
            >
                <UploadIcon />
                <p className="text-sm text-on-surface-secondary">이미지를 드래그 앤 드롭하거나 클릭하여 업로드</p>
                <p className="text-xs text-gray-500 mt-1">PNG, JPG, GIF 등</p>
            </div>
        )}
      </div>
      <div>
        <div className="flex items-center justify-between mb-2">
            <p className="text-sm text-on-surface-secondary">혹은 텍스트 예시를 사용해보세요:</p>
            <button onClick={handleFetchNewExamples} disabled={isFetchingExamples || disabled} className="text-on-surface-secondary hover:text-primary disabled:text-gray-600 disabled:cursor-wait p-1 rounded-full transition-colors" aria-label="다른 예시 보기">
                <RefreshIcon spinning={isFetchingExamples} />
            </button>
        </div>
        <div className="flex flex-wrap gap-2">
          {examplePrompts.map((prompt) => (
            <button key={prompt} onClick={() => !disabled && setUserInput(prompt)} disabled={disabled} className="text-xs bg-gray-700 text-on-surface-secondary px-3 py-1 rounded-full hover:bg-gray-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
              {prompt}
            </button>
          ))}
        </div>
      </div>
      <button
        onClick={onSubmit}
        disabled={isLoading || (!userInput.trim() && !image) || disabled}
        className="w-full bg-primary text-white font-bold py-3 px-4 rounded-md flex items-center justify-center transition-all duration-200 ease-in-out hover:bg-primary-hover disabled:bg-gray-500 disabled:cursor-not-allowed transform hover:scale-105 active:scale-100 mt-auto"
      >
        {isLoading ? <LoadingSpinner /> : <span className="text-base">피드백 구체화하기 (Ctrl+Enter)</span>}
      </button>
    </div>
  );
}

// --- App ---
const fileToBase64 = (file) => {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = () => {
      const result = reader.result;
      if (typeof result !== 'string') {
        reject(new Error("File could not be read as data URL."));
        return;
      }
      const mimeType = result.split(';')[0].split(':')[1];
      const data = result.split(',')[1];
      resolve({ mimeType, data });
    };
    reader.onerror = (error) => reject(error);
  });
};

function App() {
  const [userInput, setUserInput] = useState('');
  const [image, setImage] = useState(null);
  const [results, setResults] = useState([]);
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState(null);
  const [hasTranslated, setHasTranslated] = useState(!!initialError);

  useEffect(() => {
    if (initialError) {
        setError(initialError);
    }
  }, []);

  const handleSubmit = useCallback(async () => {
    if ((!userInput.trim() && !image) || isLoading || initialError) return;
    setIsLoading(true); setError(null); setResults([]); setHasTranslated(true);
    try {
      let imagePart;
      if (image) {
        const { mimeType, data } = await fileToBase64(image);
        imagePart = { inlineData: { mimeType, data } };
      }
      const feedbackText = userInput.trim() || "첨부된 이미지를 분석하고 개선점을 제안해주세요.";
      const translatedSuggestions = await translateFeedback(feedbackText, imagePart);
      setResults(translatedSuggestions);
    } catch (err) {
      console.error(err);
      setError(err instanceof Error ? err.message : '피드백을 번역하는 중 오류가 발생했습니다.');
    } finally {
      setIsLoading(false);
    }
  }, [userInput, image, isLoading]);

  return (
    <div className="min-h-screen bg-brand-bg text-on-surface font-sans flex flex-col">
      <Header />
      <main className="flex-grow container mx-auto p-4 md:p-8 flex flex-col lg:flex-row gap-8">
        <div className="lg:w-1/3 lg:flex-shrink-0">
          <FeedbackInput {...{userInput, setUserInput, image, setImage, onSubmit: handleSubmit, isLoading, disabled: !!initialError}} />
        </div>
        <div className="lg:w-2/3 lg:flex-grow">
          <ResultsDisplay {...{results, isLoading, error, hasTranslated}} />
        </div>
      </main>
      <Footer />
    </div>
  );
}

// --- Entry Point ---
const rootElement = document.getElementById('root');
if (!rootElement) {
  throw new Error("Could not find root element to mount to");
}
const root = ReactDOM.createRoot(rootElement);
root.render(
  <React.StrictMode>
    <App />
  </React.StrictMode>
);
    </script>
  <script type="module" src="/index.tsx"></script>
</body>
</html>
